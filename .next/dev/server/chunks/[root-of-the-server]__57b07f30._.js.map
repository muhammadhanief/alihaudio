{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///D:/2026/SID/Sistem%20Informasi/inialihaudio/alihaudio/lib/db.ts"],"sourcesContent":["import mysql from 'mysql2/promise';\r\n\r\nconst pool = mysql.createPool({\r\n    host: process.env.DB_HOST || 'localhost',\r\n    user: process.env.DB_USER || 'root',\r\n    password: process.env.DB_PASSWORD || '',\r\n    database: process.env.DB_NAME || 'alihaudio',\r\n    waitForConnections: true,\r\n    connectionLimit: 10,\r\n    queueLimit: 0,\r\n});\r\n\r\nexport default pool;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,OAAO,8IAAK,CAAC,UAAU,CAAC;IAC1B,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;AAChB;uCAEe"}},
    {"offset": {"line": 156, "column": 0}, "map": {"version":3,"sources":["file:///D:/2026/SID/Sistem%20Informasi/inialihaudio/alihaudio/app/api/save-conversion/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport pool from \"@/lib/db\";\r\nimport { cookies } from \"next/headers\";\r\nimport fs from \"fs/promises\";\r\nimport path from \"path\";\r\n\r\nexport const config = {\r\n    api: {\r\n        bodyParser: {\r\n            sizeLimit: \"50mb\",\r\n        },\r\n    },\r\n};\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        // Gunakan formData() agar bisa bypass limit JSON di server\r\n        const formData = await req.formData();\r\n        const text = formData.get(\"text\") as string;\r\n        const judul = formData.get(\"judul\") as string;\r\n        const mode = formData.get(\"mode\") as string;\r\n        const lang = formData.get(\"lang\") as string;\r\n        const provider = formData.get(\"provider\") as string;\r\n        const audioFile = formData.get(\"audio\") as File | null;\r\n\r\n        const cookieStore = await cookies();\r\n        const session = cookieStore.get(\"auth_session\");\r\n        const isGuest = formData.get(\"isGuest\") === \"true\";\r\n\r\n        let user_nipp = \"GUEST\";\r\n\r\n        if (isGuest) {\r\n            // Pastikan akun GUEST ada di tabel users agar lolos pengecekan Foreign Key MySQL\r\n            try {\r\n                await pool.query(\r\n                    `INSERT INTO users (nipp, nama, role) \r\n                     VALUES ('GUEST', 'Tamu', 'user')\r\n                     ON DUPLICATE KEY UPDATE last_login = CURRENT_TIMESTAMP`\r\n                );\r\n            } catch (dbErr) {\r\n                console.error(\"Gagal inisialisasi user GUEST:\", dbErr);\r\n            }\r\n        } else {\r\n            if (!session) {\r\n                return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n            }\r\n\r\n            const user = JSON.parse(session.value);\r\n            user_nipp = user.nipp || user.username || user.nip;\r\n\r\n            if (!user_nipp) {\r\n                return NextResponse.json({ error: \"Invalid user session: NIPP missing\" }, { status: 401 });\r\n            }\r\n        }\r\n\r\n        // --- SAVE MP3 FILE ---\r\n        let audioPath = null;\r\n        if (audioFile) {\r\n            const fileName = `voice-${user_nipp}-${Date.now()}.mp3`;\r\n            const uploadDir = path.join(process.cwd(), \"public\", \"uploads\", \"audio\");\r\n            const filePath = path.join(uploadDir, fileName);\r\n\r\n            // Ensure directory exists\r\n            await fs.mkdir(uploadDir, { recursive: true });\r\n\r\n            // Simpan langsung dari buffer file (lebih hemat memori)\r\n            const buffer = Buffer.from(await audioFile.arrayBuffer());\r\n            await fs.writeFile(filePath, buffer);\r\n\r\n            audioPath = `/uploads/audio/${fileName}`;\r\n        }\r\n\r\n        // Save to database (termasuk kolom judul)\r\n        await pool.query(\r\n            `INSERT INTO conversions (user_nipp, judul, text_input, mode, lang, provider, audio_path) \r\n             VALUES (?, ?, ?, ?, ?, ?, ?)`,\r\n            [user_nipp, judul || null, text, mode, lang, provider, audioPath]\r\n        );\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            message: \"Conversion saved\",\r\n            audioPath\r\n        });\r\n    } catch (error: any) {\r\n        console.error(\"Save Conversion Error:\", error);\r\n        return NextResponse.json(\r\n            { error: \"Internal server error: \" + error.message },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,MAAM,SAAS;IAClB,KAAK;QACD,YAAY;YACR,WAAW;QACf;IACJ;AACJ;AAEO,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,2DAA2D;QAC3D,MAAM,WAAW,MAAM,IAAI,QAAQ;QACnC,MAAM,OAAO,SAAS,GAAG,CAAC;QAC1B,MAAM,QAAQ,SAAS,GAAG,CAAC;QAC3B,MAAM,OAAO,SAAS,GAAG,CAAC;QAC1B,MAAM,OAAO,SAAS,GAAG,CAAC;QAC1B,MAAM,WAAW,SAAS,GAAG,CAAC;QAC9B,MAAM,YAAY,SAAS,GAAG,CAAC;QAE/B,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,UAAU,YAAY,GAAG,CAAC;QAChC,MAAM,UAAU,SAAS,GAAG,CAAC,eAAe;QAE5C,IAAI,YAAY;QAEhB,IAAI,SAAS;YACT,iFAAiF;YACjF,IAAI;gBACA,MAAM,sHAAI,CAAC,KAAK,CACZ,CAAC;;2EAEsD,CAAC;YAEhE,EAAE,OAAO,OAAO;gBACZ,QAAQ,KAAK,CAAC,kCAAkC;YACpD;QACJ,OAAO;YACH,IAAI,CAAC,SAAS;gBACV,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAe,GAAG;oBAAE,QAAQ;gBAAI;YACtE;YAEA,MAAM,OAAO,KAAK,KAAK,CAAC,QAAQ,KAAK;YACrC,YAAY,KAAK,IAAI,IAAI,KAAK,QAAQ,IAAI,KAAK,GAAG;YAElD,IAAI,CAAC,WAAW;gBACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAqC,GAAG;oBAAE,QAAQ;gBAAI;YAC5F;QACJ;QAEA,wBAAwB;QACxB,IAAI,YAAY;QAChB,IAAI,WAAW;YACX,MAAM,WAAW,CAAC,MAAM,EAAE,UAAU,CAAC,EAAE,KAAK,GAAG,GAAG,IAAI,CAAC;YACvD,MAAM,YAAY,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,UAAU,WAAW;YAChE,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,WAAW;YAEtC,0BAA0B;YAC1B,MAAM,gIAAE,CAAC,KAAK,CAAC,WAAW;gBAAE,WAAW;YAAK;YAE5C,wDAAwD;YACxD,MAAM,SAAS,OAAO,IAAI,CAAC,MAAM,UAAU,WAAW;YACtD,MAAM,gIAAE,CAAC,SAAS,CAAC,UAAU;YAE7B,YAAY,CAAC,eAAe,EAAE,UAAU;QAC5C;QAEA,0CAA0C;QAC1C,MAAM,sHAAI,CAAC,KAAK,CACZ,CAAC;yCAC4B,CAAC,EAC9B;YAAC;YAAW,SAAS;YAAM;YAAM;YAAM;YAAM;YAAU;SAAU;QAGrE,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT,SAAS;YACT;QACJ;IACJ,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,OAAO,4BAA4B,MAAM,OAAO;QAAC,GACnD;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}