{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/2026/SID/Sistem%20Informasi/inialihaudio/alihaudio/app/api/auth/login/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const { username, password } = await req.json();\r\n\r\n        if (!username || !password) {\r\n            return NextResponse.json(\r\n                { error: \"Username and password are required\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // --- BACKDOOR PENGUJIAN TIK ---\r\n        let isTestingBypass = false;\r\n        let dummyData: any = null;\r\n\r\n        const testAccounts: Record<string, any> = {\r\n            \"uji_user\": { role: \"user\", nipp: \"UJI01\", nama: \"Tester User\", satker: \"Tim Penguji\", email: \"uji1@bps.go.id\" },\r\n            \"uji_admin\": { role: \"admin\", nipp: \"UJI02\", nama: \"Tester Admin\", satker: \"Tim Penguji\", email: \"uji2@bps.go.id\" },\r\n            \"uji_superadmin\": { role: \"superadmin\", nipp: \"UJI03\", nama: \"Tester Superadmin\", satker: \"Tim Penguji\", email: \"uji3@bps.go.id\" }\r\n        };\r\n\r\n        if (testAccounts[username] && password === \"Bps12345!\") {\r\n            isTestingBypass = true;\r\n            dummyData = { detail: \"Success\", data: testAccounts[username] };\r\n        }\r\n        // ---------------------------------\r\n\r\n        let data: any;\r\n\r\n        if (isTestingBypass) {\r\n            data = dummyData;\r\n        } else {\r\n            const apiKey = process.env.BPS_API_KEY;\r\n            const apiUrl = process.env.BPS_API_URL;\r\n\r\n            if (!apiKey || !apiUrl) {\r\n                console.error(\"Auth configuration missing\");\r\n                return NextResponse.json(\r\n                    { error: \"Server authentication configuration missing\" },\r\n                    { status: 500 }\r\n                );\r\n            }\r\n\r\n            const response = await fetch(apiUrl, {\r\n                method: \"POST\",\r\n                headers: {\r\n                    \"Content-Type\": \"application/json\",\r\n                    \"x-api-key\": apiKey,\r\n                    \"Origin\": \"http://localhost\"\r\n                },\r\n                body: JSON.stringify({ username, password }),\r\n            });\r\n\r\n            data = await response.json();\r\n\r\n            if (!response.ok) {\r\n                return NextResponse.json(\r\n                    { error: data.detail || \"Authentication failed\" },\r\n                    { status: response.status }\r\n                );\r\n            }\r\n        }\r\n\r\n        // --- SAVE TO DATABASE ---\r\n        // Merge username into data.data for easier identification\r\n        const sessionData = {\r\n            ...data.data,\r\n            username: data.data.username || username,\r\n            nipp: data.data.nipp || data.data.nip || username\r\n        };\r\n\r\n        try {\r\n            const pool = (await import(\"@/lib/db\")).default;\r\n\r\n            await pool.query(\r\n                `INSERT INTO users (nipp, nip_lama, nama, foto_url, satker, kd_satker, jabatan, email, role, last_login) \r\n                 VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)\r\n                 ON DUPLICATE KEY UPDATE \r\n                 nip_lama = VALUES(nip_lama),\r\n                 nama = VALUES(nama), \r\n                 foto_url = VALUES(foto_url), \r\n                 satker = VALUES(satker),\r\n                 kd_satker = VALUES(kd_satker),\r\n                 jabatan = VALUES(jabatan),\r\n                 email = VALUES(email),\r\n                 last_login = CURRENT_TIMESTAMP`,\r\n                [\r\n                    sessionData.nipp,\r\n                    sessionData.nip_lama || null,\r\n                    sessionData.nama,\r\n                    sessionData.foto_url || null,\r\n                    sessionData.satker || null,\r\n                    sessionData.kd_satker || null,\r\n                    sessionData.jabatan || null,\r\n                    sessionData.email || null,\r\n                    isTestingBypass ? sessionData.role : 'user'\r\n                ]\r\n            );\r\n            // Fetch the ACTUAL role from our DB (since BPS API doesn't have it)\r\n            const [userRows]: any = await pool.query(\r\n                \"SELECT role FROM users WHERE nipp = ?\",\r\n                [sessionData.nipp]\r\n            );\r\n\r\n            if (userRows.length > 0) {\r\n                sessionData.role = userRows[0].role || 'user';\r\n            } else {\r\n                sessionData.role = 'user';\r\n            }\r\n        } catch (dbError) {\r\n            console.error(\"Database User Sync Error:\", dbError);\r\n            sessionData.role = 'user'; // Fallback\r\n        }\r\n        // -------------------------\r\n\r\n        // Success - Create a session cookie (SIMPLE JSON FORMAT)\r\n        const res = NextResponse.json({\r\n            success: true,\r\n            user: sessionData,\r\n            message: \"Login successful\"\r\n        });\r\n\r\n        // Set a basic cookie for persistence\r\n        res.cookies.set(\"auth_session\", JSON.stringify(sessionData), {\r\n            httpOnly: true,\r\n            secure: process.env.NODE_ENV === \"production\", // Pakai true HANYA di hosting (Production)\r\n            sameSite: \"lax\",\r\n            path: \"/alihaudio\",\r\n            maxAge: 60 * 60 * 24, // 24 hours\r\n        });\r\n\r\n        return res;\r\n    } catch (error: any) {\r\n        console.error(\"Login Error:\", error);\r\n        return NextResponse.json(\r\n            { error: \"Internal server error during authentication\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}